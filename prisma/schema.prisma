// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Season {
  id                Int      @id @default(autoincrement())
  startYear         Int      @map("start_year")
  endYear           Int      @map("end_year")
  label             String   @db.VarChar(50)
  membershipAmount  Decimal  @map("membership_amount") @db.Decimal(10, 2)
  isActive          Boolean  @default(false) @map("is_active")
  discountPercent   Int      @default(10) @map("discount_percent") 
  totalDonations Decimal @default(0) @map("total_donations") @db.Decimal(10, 2)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")        

  registrations     Registration[]
  workshopPrices    WorkshopPrice[]
  memberships       Membership[]
  payments          Payment[]

  @@unique([startYear, endYear])
  @@map("seasons")
}

model Family {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  address     String?  @db.Text
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  members     Member[]
  payments    Payment[]

  @@map("families")
}

model Member {
  id        Int      @id @default(autoincrement())
  familyId  Int?     @map("family_id")
  lastName  String   @map("last_name") @db.VarChar(100)
  firstName String   @map("first_name") @db.VarChar(100)
  isMinor   Boolean  @default(false) @map("is_minor")
  email     String?  @db.VarChar(255)
  phone     String?  @db.VarChar(20)

  guardianLastName  String? @map("guardian_last_name") @db.VarChar(100)
  guardianFirstName String? @map("guardian_first_name") @db.VarChar(100)
  guardianPhone     String? @map("guardian_phone") @db.VarChar(20)
  guardianEmail     String? @map("guardian_email") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  family        Family?        @relation(fields: [familyId], references: [id], onDelete: SetNull)
  registrations Registration[]
  memberships   Membership[]
  payments      Payment[]

  @@index([familyId])
  @@index([lastName, firstName])
  @@map("members")
}

model Workshop {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  allowMultiple         Boolean  @default(false) @map("allow_multiple")
  maxPerMember          Int?     @map("max_per_member")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  workshopPrices           WorkshopPrice[]
  workshopRegistrations    WorkshopRegistration[]

  @@map("workshops")
}

model WorkshopPrice {
  id         Int      @id @default(autoincrement())
  workshopId Int      @map("workshop_id")
  seasonId   Int      @map("season_id")
  amount     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  season   Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([workshopId, seasonId])
  @@map("workshop_prices")
}

model Registration {
  id                 Int      @id @default(autoincrement())
  memberId           Int      @map("member_id")
  seasonId           Int      @map("season_id")
  registrationDate   DateTime @default(now()) @map("registration_date") @db.Date
  familyOrder        Int      @default(1) @map("family_order")
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  member                Member                @relation(fields: [memberId], references: [id], onDelete: Cascade)
  season                Season                @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  workshopRegistrations WorkshopRegistration[]

  @@unique([memberId, seasonId])
  @@index([memberId])
  @@index([seasonId])
  @@map("registrations")
}

model WorkshopRegistration {
  id                 Int      @id @default(autoincrement())
  registrationId     Int      @map("registration_id")
  workshopId         Int      @map("workshop_id")
  quantity           Int      @default(1)
  appliedPrice       Decimal  @map("applied_price") @db.Decimal(10, 2)
  discountPercent    Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  registrationDate   DateTime @default(now()) @map("registration_date") @db.Date
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  registration          Registration          @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  workshop              Workshop              @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  @@unique([registrationId, workshopId])
  @@index([registrationId])
  @@map("workshop_registrations")
}

model Membership {
  id              Int      @id @default(autoincrement())
  memberId        Int      @map("member_id")
  seasonId        Int      @map("season_id")
  amount          Decimal  @db.Decimal(10, 2)
  status          String   @default("pending") @db.VarChar(20)
  membershipDate  DateTime @default(now()) @map("membership_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  season  Season  @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([memberId, seasonId])
  @@index([memberId])
  @@index([seasonId])
  @@map("memberships")
}

model Payment {
  id           Int        @id @default(autoincrement())
  familyId     Int?       @map("family_id")
  memberId     Int?       @map("member_id")
  seasonId     Int?       @map("season_id")
  showClientId Int?       @map("show_client_id")

  amount       Decimal    @db.Decimal(10, 2)
  paymentType  String     @map("payment_type") @db.VarChar(20) // cash, check, transfer, card
  paymentDate  DateTime   @map("payment_date") @db.Date
  cashingDate  DateTime?  @map("cashing_date") @db.Date
  status       String     @default("pending") @db.VarChar(20)
  
  reference    String?     @db.VarChar(50)
  notes        String?     @db.Text
  
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @default(now()) @updatedAt @map("updated_at")
  
  family       Family?     @relation(fields: [familyId], references: [id], onDelete: SetNull)
  member       Member?     @relation(fields: [memberId], references: [id], onDelete: SetNull)
  season       Season?     @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  showClient   ShowClient? @relation(fields: [showClientId], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([memberId])
  @@index([seasonId])
  @@index([status])
  @@map("payments")
}

model ShowClient {
  id              Int      @id @default(autoincrement())
  name            String   @db.VarChar(200)
  contactName     String?  @map("contact_name") @db.VarChar(100)
  email           String?  @db.VarChar(255)
  phone           String?  @db.VarChar(20)
  address         String?  @db.Text
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  shows           Show[]
  payments        Payment[]

  @@index([name])
  @@map("show_clients")
}

model Show {
  id              Int       @id @default(autoincrement())
  clientId        Int       @map("client_id")
  title           String    @db.VarChar(200)
  description     String?   @db.Text
  proposedDate    DateTime? @map("proposed_date") @db.Date
  duration        Int?
  proposedPrice   Decimal   @map("proposed_price") @db.Decimal(10, 2)
  status          String    @default("pending") @db.VarChar(20)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  client          ShowClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([proposedDate])
  @@map("shows")
}