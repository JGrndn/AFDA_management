// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model Season {
  id                Int      @id @default(autoincrement())
  startYear         Int      @map("start_year")
  endYear           Int      @map("end_year")
  label             String   @db.VarChar(50)
  membershipAmount  Decimal  @map("membership_amount") @db.Decimal(10, 2)
  isActive          Boolean  @default(false) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")

  registrations     Registration[]
  workshopPrices    WorkshopPrice[]
  memberships       Membership[]

  @@unique([startYear, endYear])
  @@map("seasons")
}

model Family {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  address     String?  @db.Text
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")

  members Member[]

  @@map("families")
}

model Member {
  id        Int      @id @default(autoincrement())
  familyId  Int?     @map("family_id")
  lastName  String   @map("last_name") @db.VarChar(100)
  firstName String   @map("first_name") @db.VarChar(100)
  isMinor   Boolean  @default(false) @map("is_minor")
  email     String?  @db.VarChar(255)
  phone     String?  @db.VarChar(20)

  guardianLastName  String? @map("guardian_last_name") @db.VarChar(100)
  guardianFirstName String? @map("guardian_first_name") @db.VarChar(100)
  guardianPhone     String? @map("guardian_phone") @db.VarChar(20)
  guardianEmail     String? @map("guardian_email") @db.VarChar(255)
  guardianRelation  String? @map("guardian_relation") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  family        Family?        @relation(fields: [familyId], references: [id], onDelete: SetNull)
  registrations Registration[]
  memberships   Membership[]

  @@index([familyId])
  @@index([lastName, firstName])
  @@map("members")
}

model Workshop {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  workshopPrices           WorkshopPrice[]
  workshopRegistrations    WorkshopRegistration[]

  @@map("workshops")
}

model WorkshopPrice {
  id         Int      @id @default(autoincrement())
  workshopId Int      @map("workshop_id")
  seasonId   Int      @map("season_id")
  amount     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  season   Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([workshopId, seasonId])
  @@map("workshop_prices")
}

model Registration {
  id                 Int      @id @default(autoincrement())
  memberId           Int      @map("member_id")
  seasonId           Int      @map("season_id")
  registrationDate   DateTime @default(now()) @map("registration_date") @db.Date
  familyOrder        Int      @default(1) @map("family_order")
  status             String   @default("pending") @db.VarChar(20)
  createdAt          DateTime @default(now()) @map("created_at")

  member                Member                @relation(fields: [memberId], references: [id], onDelete: Cascade)
  season                Season                @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  workshopRegistrations WorkshopRegistration[]
  paymentRegistrations  PaymentRegistration[]

  @@unique([memberId, seasonId])
  @@index([memberId])
  @@index([seasonId])
  @@map("registrations")
}

model WorkshopRegistration {
  id                 Int      @id @default(autoincrement())
  registrationId     Int      @map("registration_id")
  workshopId         Int      @map("workshop_id")
  appliedPrice       Decimal  @map("applied_price") @db.Decimal(10, 2)
  discountPercent    Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  registrationDate   DateTime @default(now()) @map("registration_date") @db.Date
  createdAt          DateTime @default(now()) @map("created_at")

  registration          Registration          @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  workshop              Workshop              @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  paymentRegistrations  PaymentRegistration[]

  @@unique([registrationId, workshopId])
  @@index([registrationId])
  @@map("workshop_registrations")
}

model PaymentGroup {
  id              Int       @id @default(autoincrement())
  reference       String?   @unique @db.VarChar(50)
  totalAmount     Decimal   @map("total_amount") @db.Decimal(10, 2)
  paymentType     String    @map("payment_type") @db.VarChar(20)
  paymentDate     DateTime  @map("payment_date") @db.Date
  cashingDate     DateTime? @map("cashing_date") @db.Date
  status          String    @default("pending") @db.VarChar(20)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  paymentRegistrations  PaymentRegistration[]
  paymentMemberships    PaymentMembership[]

  @@index([status])
  @@index([cashingDate])
  @@map("payment_groups")
}

model PaymentRegistration {
  id                      Int      @id @default(autoincrement())
  paymentGroupId          Int      @map("payment_group_id")
  registrationId          Int      @map("registration_id")
  allocatedAmount         Decimal  @map("allocated_amount") @db.Decimal(10, 2)
  amountType              String   @map("amount_type") @db.VarChar(20)
  workshopRegistrationId  Int?     @map("workshop_registration_id")
  createdAt               DateTime @default(now()) @map("created_at")

  paymentGroup          PaymentGroup          @relation(fields: [paymentGroupId], references: [id], onDelete: Cascade)
  registration          Registration          @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  workshopRegistration  WorkshopRegistration? @relation(fields: [workshopRegistrationId], references: [id], onDelete: SetNull)

  @@index([paymentGroupId])
  @@index([registrationId])
  @@map("payment_registrations")
}

model Membership {
  id              Int      @id @default(autoincrement())
  memberId        Int      @map("member_id")
  seasonId        Int      @map("season_id")
  amount          Decimal  @db.Decimal(10, 2)
  status          String   @default("pending") @db.VarChar(20)
  membershipDate  DateTime @default(now()) @map("membership_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at")

  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  season  Season  @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  paymentMemberships PaymentMembership[]

  @@unique([memberId, seasonId])
  @@index([memberId])
  @@index([seasonId])
  @@map("memberships")
}

model PaymentMembership {
  id              Int      @id @default(autoincrement())
  paymentGroupId  Int      @map("payment_group_id")
  membershipId    Int      @map("membership_id")
  allocatedAmount Decimal  @map("allocated_amount") @db.Decimal(10, 2)
  createdAt       DateTime @default(now()) @map("created_at")

  paymentGroup  PaymentGroup  @relation(fields: [paymentGroupId], references: [id], onDelete: Cascade)
  membership    Membership    @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([paymentGroupId])
  @@index([membershipId])
  @@map("payment_memberships")
}